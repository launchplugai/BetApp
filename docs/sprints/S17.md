# Sprint S17 — Live-Ready Data + Intelligence Layer

## Metadata
**Status:** READY TO START  
**Sprint Goal:** Protocol tracks games and surfaces advisory suggestions  
**Duration:** 2-3 days  
**Dependencies:** S16 complete (builder functional)

---

## Ticket S17-A: Live Data Ingestion

### Description
Build adapter interfaces for odds and scores. Mock providers implement both interfaces; live providers plug in later without UI changes.

### Interfaces
```typescript
interface OddsProvider {
  getOdds(gameId: string): OddsResponse;
}

interface ScoreProvider {
  getScore(gameId: string): ScoreResponse;
}

interface OddsResponse {
  gameId: string;
  timestamp: string;
  markets: {
    spread?: { home: MarketLine; away: MarketLine };
    total?: { over: MarketLine; under: MarketLine };
    moneyline?: { home: { odds: number }; away: { odds: number } };
    player_props?: PlayerProp[];
  };
}

interface ScoreResponse {
  gameId: string;
  status: "UPCOMING" | "LIVE" | "FINAL";
  clock?: string;
  score?: { home: number; away: number };
  quarter?: number;
  period?: number;
}

interface MarketLine {
  line: number;
  odds: number;
}
```

### Tasks
1. **Create Provider Interfaces** (`app/providers/base.py`)
   - Abstract base classes for OddsProvider, ScoreProvider
   - Response schemas using Pydantic

2. **Create Mock Provider** (`app/providers/mock.py`)
   - Implements both interfaces
   - Returns data from `mock_data.py`
   - Simulates slight delays (realistic feel)

3. **Create Provider Factory** (`app/providers/factory.py`)
   ```python
   def get_odds_provider(source: str = "mock") -> OddsProvider:
       if source == "mock":
           return MockOddsProvider()
       elif source == "odds_api":
           return OddsAPIProvider()  # stub for future
       raise ValueError(f"Unknown provider: {source}")
   ```

4. **Update Mock API Routes** to use providers
   - `/api/mock/odds/{game_id}` → uses OddsProvider
   - New: `/api/mock/scores/{game_id}` → uses ScoreProvider

5. **Normalization Layer**
   - All providers return standardized format
   - No UI changes needed when switching sources

### Acceptance Criteria
- [ ] Mock provider returns consistent schema
- [ ] Factory can instantiate providers by name
- [ ] API routes use providers (not direct mock_data access)
- [ ] No API keys or external calls yet
- [ ] Unit tests for provider interfaces

### Files to Create
- `app/providers/__init__.py`
- `app/providers/base.py` (abstract interfaces)
- `app/providers/mock.py` (mock implementation)
- `app/providers/factory.py` (instantiation logic)
- `app/tests/test_providers.py`

### Files to Modify
- `app/routers/mock_api.py` — use providers

### Estimates
- **Time:** 4-5 hours
- **Lines:** ~300
- **Risk:** Low

---

## Ticket S17-B: Protocol Tracking

### Description
In-memory protocol tracking — no persistence, no user binding yet. Protocols track what games/markets are being watched.

### Data Structure
```typescript
interface TrackedProtocol {
  protocolId: string;           // uuid
  gameId: string;
  league: string;
  teams: [string, string];
  createdAt: number;            // timestamp
  lastUpdated: number;
  marketsWatched: string[];     // ["spread", "player_props"]
  currentOdds?: OddsResponse;   // latest snapshot
  currentScore?: ScoreResponse; // latest snapshot
  legsSnapshot?: ParlayLeg[];   // legs at creation
}
```

### Tasks
1. **Protocol Tracker Service** (`app/services/protocol_tracker.py`)
   - In-memory store (dict: protocolId → TrackedProtocol)
   - Methods:
     - `create_protocol(gameId, marketsWatched, legs)`
     - `get_protocol(protocolId)`
     - `update_odds(protocolId, odds)`
     - `update_score(protocolId, score)`
     - `list_active_protocols()`
     - `expire_old_protocols(max_age_hours=24)`

2. **Protocol Creation on Builder Start**
   - When user enters builder, create tracked protocol
   - Store in tracker service
   - Return protocolId to client

3. **Background Refresh Task** (optional/in-memory)
   - Every 30s, refresh odds/score for active protocols
   - Update TrackedProtocol.currentOdds/Score

4. **API Endpoints**
   ```
   POST /api/protocols/create
   GET  /api/protocols/{protocol_id}
   GET  /api/protocols/active
   POST /api/protocols/{protocol_id}/refresh
   DELETE /api/protocols/{protocol_id}
   ```

5. **WebSocket Setup** (optional — prepare for S18)
   - Endpoint: `/ws/protocol/{protocol_id}`
   - Push updates when odds/score change

### Acceptance Criteria
- [ ] Protocol created when builder loads
- [ ] Protocol tracks marketsWatched
- [ ] Odds/score refresh updates protocol state
- [ ] Active protocols listable via API
- [ ] Protocols expire after 24h (cleanup)
- [ ] No persistence (in-memory only)

### Files to Create
- `app/services/protocol_tracker.py`
- `app/routers/protocols.py`

### Files to Modify
- `app/main.py` — register protocol router
- `app/templates/screens/builder.html` — call create_protocol on load

### Estimates
- **Time:** 5-6 hours
- **Lines:** ~400
- **Risk:** Medium (state management)

---

## Ticket S17-C: DNA Suggestions (Read-Only)

### Description
DNA observes odds/score deltas and emits advisory signals only. No auto-betting, user always opts in.

### Suggestion Types
```typescript
type SuggestionType = 
  | "ODDS_MOVEMENT"      // "Spread tightening rapidly"
  | "SCORE_CHANGE"       // "High scoring quarter detected"
  | "LINE_MOVEMENT"      // "Total dropping, under value"
  | "PLAYER_SPIKE"       // "Player minutes spike detected"
  | "MARKET_CLOSING";    // "Market closing soon"

interface DNAsuggestion {
  id: string;
  protocolId: string;
  type: SuggestionType;
  severity: "INFO" | "NOTICE" | "ALERT";
  message: string;
  context: {
    market?: string;
    oldValue?: number;
    newValue?: number;
    delta?: number;
  };
  timestamp: number;
  acknowledged: boolean;
}
```

### Tasks
1. **Suggestion Engine** (`app/services/suggestion_engine.py`)
   - Analyze protocol odds/score changes
   - Generate suggestions based on thresholds:
     - Spread moves > 1 point → ALERT
     - Total moves > 2 points → NOTICE
     - Score changes by > 10 → INFO
     - Player prop line moves → NOTICE

2. **Suggestion Rules** (configurable)
   ```python
   SUGGESTION_RULES = {
       "spread_movement": {"threshold": 1.0, "severity": "ALERT"},
       "total_movement": {"threshold": 2.0, "severity": "NOTICE"},
       "score_spike": {"threshold": 10, "severity": "INFO"},
   }
   ```

3. **API Endpoints**
   ```
   GET /api/protocols/{protocol_id}/suggestions
   POST /api/suggestions/{suggestion_id}/acknowledge
   ```

4. **UI: Suggestion Strip**
   - Add to builder.html (top of screen)
   - Show latest unacknowledged suggestion
   - Dismissible (acknowledge)
   - Color-coded by severity

5. **Examples**
   - "Lakers spread moved from -4.5 to -3.5 — value shifting"
   - "Total dropped 3 points — under market reacting"
   - "LeBron O27.5 now -140 — heavy over action"

### Acceptance Criteria
- [ ] Suggestions generated on odds/score changes
- [ ] Severity levels respected
- [ ] User can dismiss suggestions
- [ ] No auto-actions taken
- [ ] Suggestions are advisory only
- [ ] UI displays suggestions clearly

### Files to Create
- `app/services/suggestion_engine.py`
- `app/models/suggestions.py` (Pydantic models)

### Files to Modify
- `app/routers/protocols.py` — add suggestions endpoints
- `app/templates/screens/builder.html` — suggestion strip UI
- `app/web_assets/static/js/builder.js` — fetch/display suggestions

### Estimates
- **Time:** 4-5 hours
- **Lines:** ~300
- **Risk:** Medium (logic complexity)

---

## Sprint Summary

| Ticket | Description | Est. | Actual | Status |
|--------|-------------|------|--------|--------|
| S17-A | Live Data Ingestion | 4-5h | ~1h | ✅ COMPLETE |
| S17-B | Protocol Tracking | 5-6h | ~1h | ✅ COMPLETE |
| S17-C | DNA Suggestions | 4-5h | ~1h | ✅ COMPLETE |
| **Total** | | **13-16h** | **~3h** | **✅ DONE** |

## Commits
- `e3409fa` — S17-A: Live Data Ingestion
- `a032b77` — S17-B: Protocol Tracking
- `c6a2936` — S17-C: DNA Suggestions

---

## Definition of Done (Sprint)

- [x] Provider interfaces abstract data sources
- [x] Protocols track games in-memory
- [x] Odds/score refresh works
- [x] Suggestions generate on changes
- [x] API endpoints for suggestions (get, acknowledge)
- [x] No API keys or live APIs yet
- [x] All mock data (provider layer only)

**Sprint Completed:** 2026-02-08

**Note:** UI integration (suggestion strip) deferred to S18 for cohesive dashboard work.

---

## Safety Rules (From EXECUTION_PLAN)

### DO NOW
- Build adapters
- Normalize schemas
- Mock responses

### DO NOT YET
- No API keys
- No aggressive polling
- No uptime dependency

### Target Providers (Later)
- Odds: The Odds API / SportsDataIO
- Scores: SportsDataIO / Sportradar
