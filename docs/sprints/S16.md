# Sprint S16 — Protocol + Parlay Builder v1

## Metadata
**Status:** READY TO START  
**Sprint Goal:** User can select an event, build a parlay visually, and analyze it via DNA  
**Duration:** 1-2 days  
**Dependencies:** None (uses existing DNA evaluate endpoint)

---

## Ticket S16-A: Protocol (Event Target Selection)

### Description
Build the event selection screen where users browse games and lock in a "protocol context" that gets passed to the parlay builder.

### Tasks
1. **Create ProtocolContext Type**
   ```typescript
   interface ProtocolContext {
     protocolId: string;      // uuid v4
     league: string;          // "NBA" (start with one)
     gameId: string;          // slug format: "lal-gsw-2026-02-08"
     teams: [string, string]; // [home, away]
     status: "UPCOMING" | "LIVE" | "FINAL";
     clock?: string;          // "Q3 8:42" (null if not live)
     score?: {
       home: number;
       away: number;
     };
     marketsAvailable: string[]; // ["spread", "total", "player_props"]
   }
   ```

2. **Update Mock Data** (`app/mock_data.py`)
   - Add 2-3 NBA games with realistic scores/status
   - Include Lakers vs Warriors as "LIVE" featured game

3. **Build Protocol Screen** (`templates/screens/protocol.html`)
   - League selector (NBA only for now, dropdown styled)
   - Featured event card (larger, highlighted)
   - Event cards list (scrollable)
   - AI Insight strip (static placeholder text)
   - "SELECT EVENT TARGET" button → routes to builder with context

4. **Add API Endpoint** (`routers/mock_api.py`)
   ```
   GET /api/mock/protocols/available?league=NBA
   Returns: ProtocolContext[]
   ```

5. **Client-Side State**
   - Store selected ProtocolContext in sessionStorage
   - Pass to builder via URL param or state

### Acceptance Criteria
- [ ] Clicking "SELECT EVENT TARGET" routes to `/new?screen=builder&protocolId={id}`
- [ ] ProtocolContext is intact in browser devtools (sessionStorage)
- [ ] No backend writes occur
- [ ] No persistence (pure in-memory)

### Files to Modify
- `app/mock_data.py` — add NBA games
- `app/routers/mock_api.py` — add protocol endpoint
- `app/templates/screens/protocol.html` — new screen (or rename browse.html)
- `app/web_assets/static/js/protocol.js` — new client logic

### Estimates
- **Time:** 3-4 hours
- **Lines:** ~200
- **Tests:** 0 (UI only, manual QA)

---

## Ticket S16-B: Parlay Builder v1

### Description
Visual parlay builder where users click to add legs, see live odds calculation, and prepare for DNA analysis.

### Tasks
1. **Canonical Leg Schema** (shared type)
   ```typescript
   interface ParlayLeg {
     id: string;              // uuid for this leg
     market: "spread" | "total" | "moneyline" | "player_prop";
     team?: string;           // for spread/moneyline
     player?: string;         // for player_prop
     prop?: string;           // "points", "rebounds", "assists"
     line: number;            // -4.5, 220.5, 25.5
     odds: number;            // -110, +150
     selection: string;       // display label: "Lakers -4.5"
   }
   ```

2. **Builder State Machine**
   ```typescript
   interface BuilderState {
     protocolId: string;           // from S16-A
     legs: ParlayLeg[];
     wager: number;                // default 100
     totalOdds: number;            // calculated
     potentialPayout: number;      // calculated
   }
   ```

3. **UI Components** (`templates/screens/builder.html`)
   - Game header (teams, score, clock from ProtocolContext)
   - Market tabs: "Main Lines" | "Player Props" | "Quarters" | "Halves"
   - Odds grid (spread/total/moneyline per team)
   - Player props list (searchable/filterable)
   - Parlay slip (right side or bottom sheet on mobile)
   - Wager input
   - Total odds display
   - Potential payout display
   - "ANALYZE WITH DNA" button

4. **Leg Management**
   - Add leg: click odds button → append to legs array
   - Remove leg: click X on leg card → splice from array
   - Duplicate prevention: disable already-selected odds
   - Conflict detection: warn if adding opposing bets (same game)

5. **Odds Calculation**
   ```javascript
   // American odds to implied probability
   function americanToDecimal(odds) {
     return odds > 0 ? (odds / 100) + 1 : (100 / Math.abs(odds)) + 1;
   }
   
   // Parlay odds (naive multiplication, no correlation adjustment)
   function calculateParlayOdds(legs) {
     const decimalOdds = legs.map(l => americanToDecimal(l.odds));
     const product = decimalOdds.reduce((a, b) => a * b, 1);
     return product >= 2 
       ? Math.round((product - 1) * 100)  // + odds
       : Math.round(-100 / (product - 1)); // - odds
   }
   
   function calculatePayout(wager, odds) {
     return odds > 0 
       ? wager + (wager * odds / 100)
       : wager + (wager * 100 / Math.abs(odds));
   }
   ```

6. **Mock Markets Data**
   ```json
   {
     "gameId": "lal-gsw-2026-02-08",
     "mainLines": {
       "spread": {
         "lal": { "line": -4.5, "odds": -110 },
         "gsw": { "line": +4.5, "odds": -110 }
       },
       "total": {
         "over": { "line": 234.5, "odds": -110 },
         "under": { "line": 234.5, "odds": -110 }
       },
       "moneyline": {
         "lal": { "odds": -200 },
         "gsw": { "odds": +170 }
       }
     },
     "playerProps": [
       { "player": "LeBron James", "prop": "points", "line": 25.5, "over": -115, "under": -105 },
       { "player": "Stephen Curry", "prop": "points", "line": 28.5, "over": -120, "under": +100 }
     ]
   }
   ```

7. **API Endpoint**
   ```
   GET /api/mock/markets/{game_id}
   Returns: markets object above
   ```

### Acceptance Criteria
- [ ] Zero typing required to build a parlay
- [ ] Add/remove leg instantly updates total odds and payout
- [ ] Duplicate legs cannot be added
- [ ] Builder state is deterministic (same actions = same state)
- [ ] Mobile: one-thumb usable (bottom sheet for slip)

### Files to Modify
- `app/mock_data.py` — add markets data
- `app/routers/mock_api.py` — add markets endpoint
- `app/templates/screens/builder.html` — overhaul existing builder
- `app/web_assets/static/js/builder.js` — new leg management logic
- `app/web_assets/static/css/neon-theme.css` — builder-specific styles

### Estimates
- **Time:** 6-8 hours
- **Lines:** ~400
- **Tests:** 0 (UI only, manual QA)

---

## Ticket S16-C: Builder → DNA Integration

### Description
Wire the parlay builder to submit legs to the existing DNA evaluate endpoint and display results.

### Tasks
1. **Submit Handler**
   ```javascript
   async function analyzeWithDNA() {
     const legs = getLegsFromState();
     const inputText = legsToText(legs); // "Lakers -4.5 + LeBron O25.5"
     
     const response = await fetch('/app/evaluate', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({
         input: inputText,
         tier: 'good',
         legs: legs.map(l => ({
           market: l.market,
           team: l.team,
           player: l.player,
           prop: l.prop,
           line: l.line
         }))
       })
     });
     
     const result = await response.json();
     displayResults(result);
   }
   ```

2. **Legs to Text Conversion**
   ```javascript
   function legsToText(legs) {
     return legs.map(l => {
       if (l.market === 'spread') return `${l.team} ${l.line > 0 ? '+' : ''}${l.line}`;
       if (l.market === 'total') return `${l.selection} ${l.line}`;
       if (l.market === 'moneyline') return `${l.team} ML`;
       if (l.market === 'player_prop') return `${l.player} ${l.prop === 'points' ? 'O' : ''}${l.line}`;
       return l.selection;
     }).join(' + ');
   }
   ```

3. **Results Display**
   - Reuse existing results panel component
   - Show verdict badge (GOOD/BETTER/BEST/RISKY)
   - Show confidence score
   - Show leg-by-leg breakdown
   - Show summary text

4. **Loading States**
   - Disable "ANALYZE" button during request
   - Show spinner
   - Handle errors gracefully (toast)

### Acceptance Criteria
- [ ] DNA response renders successfully
- [ ] No regression in analysis quality vs text input
- [ ] Existing /app/evaluate endpoint unchanged
- [ ] Results display within 3 seconds

### Files to Modify
- `app/web_assets/static/js/builder.js` — add submit handler
- `app/templates/screens/builder.html` — add results panel

### Estimates
- **Time:** 2-3 hours
- **Lines:** ~100
- **Tests:** 0 (integration test via UI)

---

## Sprint Summary

| Ticket | Description | Time | Lines | Risk |
|--------|-------------|------|-------|------|
| S16-A | Protocol (event selection) | 3-4h | 200 | Low |
| S16-B | Parlay Builder v1 | 6-8h | 400 | Medium |
| S16-C | DNA Integration | 2-3h | 100 | Low |
| **Total** | | **11-15h** | **700** | **Medium** |

---

## Definition of Done (Sprint)

- [ ] User can select an NBA game from protocol screen
- [ ] User can build a 2-4 leg parlay by clicking (no typing)
- [ ] User can see live odds/payout calculation
- [ ] User can submit to DNA and see analysis
- [ ] Works on mobile (one-thumb usable)
- [ ] All mock data (no real APIs)
- [ ] No auth/wallets/persistence

---

## Next Sprint (S17 Preview)

- OddsProvider / ScoreProvider interfaces
- Live data adapters (mock → real swap-ready)
- Protocol tracking (in-memory)
- DNA suggestions (read-only advisory)
