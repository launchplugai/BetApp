# Sprint S18 â€” Dashboard + User State

## Metadata
**Status:** READY TO START  
**Sprint Goal:** System becomes a product with memory, stats, and tiers  
**Duration:** 2-3 days  
**Dependencies:** S16 (builder), S17 (protocols) complete

---

## Ticket S18-A: User Accounts

### Description
Simple email/password auth. No social login, no OAuth. Just enough to identify users and persist their data.

### Data Model
```typescript
interface User {
  id: string;           // uuid
  email: string;        // unique
  password_hash: string; // bcrypt
  name: string;         // display name
  tier: "GOOD" | "BETTER" | "BEST";  // default GOOD
  created_at: timestamp;
  last_login: timestamp;
  preferences: {
    default_sport: string;
    notifications: boolean;
    theme: "dark" | "light";
  };
}
```

### Tasks
1. **Database Schema** (`app/models/user.py`)
   - SQLAlchemy User model
   - Migration script

2. **Auth Service** (`app/services/auth.py`)
   - `register(email, password, name)` â†’ User
   - `login(email, password)` â†’ JWT token
   - `get_current_user(token)` â†’ User
   - Password hashing (bcrypt)

3. **API Endpoints** (`app/routers/auth.py`)
   ```
   POST /api/auth/register
   POST /api/auth/login
   POST /api/auth/logout
   GET  /api/auth/me
   POST /api/auth/refresh
   ```

4. **Login/Register UI** (`templates/screens/auth.html`)
   - Tab switch: Login | Register
   - Email input
   - Password input (with show/hide)
   - Name input (register only)
   - Submit button
   - Error messages

5. **Auth State in JS**
   - Store JWT in sessionStorage
   - Add auth header to API calls
   - Auto-redirect to login if 401

### Acceptance Criteria
- [ ] Can register new account
- [ ] Can login with email/password
- [ ] JWT token persists across page refreshes (sessionStorage)
- [ ] Protected routes redirect to login
- [ ] Passwords hashed (not plaintext)

### Files to Create
- `app/models/user.py`
- `app/services/auth.py`
- `app/routers/auth.py`
- `app/templates/screens/auth.html`

### Estimates
- **Time:** 4-5 hours
- **Lines:** ~300
- **Risk:** Low

---

## Ticket S18-B: Dashboard Metrics

### Description
Personalized dashboard showing user stats, active protocols, recent activity. This is the "home" screen after login.

### Data Model
```typescript
interface UserStats {
  total_protocols: number;
  total_bets: number;
  win_rate: number;        // 0-100%
  profit_loss: number;     // +$ or -$
  current_streak: number;  // wins in a row
  best_streak: number;
}

interface DashboardData {
  user: User;
  stats: UserStats;
  active_protocols: TrackedProtocol[];
  recent_bets: Bet[];
  suggestions: DNASuggestion[];
}
```

### Tasks
1. **Stats Service** (`app/services/stats.py`)
   - Calculate win rate from bet history
   - Track profit/loss
   - Compute streaks

2. **Bet Persistence** (extend protocol tracker)
   - Store completed bets
   - Track outcomes (win/loss/pending)
   - Link to user

3. **Dashboard API** (`app/routers/dashboard.py`)
   ```
   GET /api/dashboard
   Returns: DashboardData
   ```

4. **Dashboard UI** (update `templates/screens/dashboard.html`)
   - Welcome header with user name
   - Stats cards (win rate, P&L, streak)
   - Active protocols list
   - Recent bets table
   - Quick action: "Start New Protocol"

5. **Real-time Updates** (optional)
   - Poll dashboard every 30s
   - Show live protocol updates

### Acceptance Criteria
- [ ] Dashboard shows user name and tier
- [ ] Stats calculate correctly from history
- [ ] Active protocols display
- [ ] Recent bets shown
- [ ] "Start New Protocol" routes to browse

### Files to Modify
- `app/templates/screens/dashboard.html` - full redesign
- `app/services/protocol_tracker.py` - add user linkage

### Estimates
- **Time:** 5-6 hours
- **Lines:** ~400
- **Risk:** Medium (calculation logic)

---

## Ticket S18-C: Tier Gating

### Description
GOOD / BETTER / BEST tier system. Feature flags only â€” no branching analysis logic.

### Tier Features
```typescript
const TIER_FEATURES = {
  GOOD: {
    max_legs: 4,
    max_protocols: 1,        // single game only
    suggestions: false,
    live_data: false,
    weather: false,
    history: false,
    analytics: false
  },
  BETTER: {
    max_legs: 6,
    max_protocols: 3,        // multi-game
    suggestions: true,        // S17 suggestions
    live_data: true,          // real odds/scores
    weather: false,
    history: true,            // bet history
    analytics: false
  },
  BEST: {
    max_legs: 10,
    max_protocols: 5,
    suggestions: true,
    live_data: true,
    weather: true,            // weather impact
    history: true,
    analytics: true           // detailed breakdowns
  }
};
```

### Tasks
1. **Tier Config** (`app/config/tiers.py`)
   - Feature flags per tier
   - Limits (max legs, protocols)

2. **Tier Middleware** (`app/middleware/tier.py`)
   - Check user tier on protected actions
   - Return 403 if tier insufficient
   - Error message: "Upgrade to BETTER for this feature"

3. **Tier Enforcement in UI**
   - Disable buttons if over limit
   - Show "ðŸ”’ BETTER" badge on locked features
   - Upsell prompts

4. **Upgrade Flow** (mock for now)
   - "Upgrade" button â†’ shows pricing
   - Mock checkout (no real payment yet)
   - Update user tier

5. **Tier Badges**
   - Show current tier in header
   - Color coding: GOOD (gray), BETTER (blue), BEST (gold)

### Acceptance Criteria
- [ ] GOOD users limited to 4 legs
- [ ] GOOD users see locked feature badges
- [ ] Tier displayed in UI
- [ ] Mock upgrade flow works
- [ ] Tier gates enforced server-side

### Files to Create
- `app/config/tiers.py`
- `app/middleware/tier.py`

### Estimates
- **Time:** 4-5 hours
- **Lines:** ~300
- **Risk:** Low

---

## Sprint Summary

| Ticket | Description | Est. | Risk |
|--------|-------------|------|------|
| S18-A | User Accounts | 4-5h | Low |
| S18-B | Dashboard Metrics | 5-6h | Medium |
| S18-C | Tier Gating | 4-5h | Low |
| **Total** | | **13-16h** | **Medium** |

---

## Definition of Done (Sprint)

- [ ] Can register/login
- [ ] Dashboard shows personalized stats
- [ ] Bet history persists
- [ ] Tier limits enforced (4 legs for GOOD)
- [ ] Upgrade flow (mock) works
- [ ] Demo data still works for unauthenticated users

---

## Notes

### Demo Mode
Keep unauthenticated access for marketing:
- Browse works without login
- Builder works (session only)
- Dashboard requires login

### Data Migration
When switching to real data (post-S18):
- User accounts transfer
- Bet history transfers
- Protocols don't (they're ephemeral)

### Pricing (Mock)
- GOOD: Free
- BETTER: $29/mo
- BEST: $99/mo
